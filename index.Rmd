---
title: "Desert Bird Habitat Use"
author: "Malory Owen & Christopher Lortie"
date: "2019"
output:
  html_document:
    toc: true
    toc_float: true
---

# Introduction
Bird community structure in an area changes with the seasons, as birds migrate in Spring to their Summer breeding grounds. During their migration, some will encounter habitats unlike their breeding grounds, allowing for unique interactions between mesohabitat structures. However, some birds are Summer residents of an area, meaning they are traveling *to* a particular area for their breeding season. Lastly, there are also birds that are year long residents, meaning they do not migrate to or from a location. We are investigating the relationship between different migratory classes of birds and the way they interact with available desert mesohabitats. 

Our explanatory variables, which are all metrics for diversity, include:

1. Taxanomic diversity
  + Species
  + Family
  + Order
  + Shannon Weaver Index
2. Functional diversity
  + Trophic guild
  + Migratory class

Our response variables, behavior and mesohabitat, include:

1. Behavior
  + Fine behavior
  + Broad behavior
2. Mesohabitat
  + Fine mesohabitat
  + Two level mesohabitat
  + Three level mesohabitat
  + Five level mesohabitat


```{r, libraries, include=FALSE}


library(ggplot2)
library(ggmap)
library(dplyr)
library(ggpubr)
library(tidyverse)
library(tidyr)
library(vegan)
library(corrplot)
library(distances)
library(codyn)
library(plyr)

register_google(key="")


```


Here, we are examining bird habitat use as it relates to different metrics for diversity (acutal and functional) in a low-anthropogenic-impact, well preserved desert space. 

# Data
## Raw data

```{r, data, echo=FALSE, warning=FALSE}
spring.site <- read.csv("~/Masters/Desert-Bird-Habitat-Use/data/line_transects_flower.csv")

summer.site <- read.csv("~/Masters/Desert-Bird-Habitat-Use/data/line_transects_fruit.csv")

site.all <- read.csv("~/Masters/Desert-Bird-Habitat-Use/data/line_transects.csv")


#Only visuals
site <- read.csv("~/Masters/Desert-Bird-Habitat-Use/data/line_transects_viz.csv")
head(site)

#summary stats
#taxonomy
unique(site$species)
unique(site$family)
unique(site$order)
#behaviors
unique(site$behavior)
unique(site$broad_behavior)
unique(site$mesohabitat)

```

## Explanatory Variables 

We need to create a dataset with abundances of levels in each explantory factor per walk.
```{r, explanatory variables dataset, warning=FALSE, include=FALSE}
#get count data for each explanatory variable

#species richness
species.rich <- site[,c(5, 12)] #pull season, walk, and species
species.rich.long <-  as.data.frame(table(species.rich)) #get freq of each species in long table with walks as rep
species.rich.long$walk <- as.numeric(species.rich.long$walk)
species.rich.wide <- species.rich.long %>% spread(species, Freq) #get into wide format
species.rich.wide$walk <- NULL
species.rich <- as.data.frame(specnumber(species.rich.wide)) #species richness at walk level 
 
#family richness
family.rich <- site[,c(5, 11)] #pull walk, and family 
family.rich.long <-  as.data.frame(table(family.rich)) #get freq of each species in long table with walks as rep
family.rich.long$walk <- as.numeric(family.rich.long$walk)
family.rich.wide <- family.rich.long %>% spread(family, Freq) #get into wide format
family.rich.wide$walk <- NULL
family.rich <- as.data.frame(specnumber(family.rich.wide)) #species richness at walk level 

#order richness
order.rich <- site[,c(5, 10)] #pull walk, and order
order.rich.long <-  as.data.frame(table(order.rich)) #get freq of each species in long table with walks as rep
order.rich.long$walk <- as.numeric(order.rich.long$walk)
order.rich.wide <- order.rich.long %>% spread(order, Freq) #get into wide format
order.rich.wide$walk <- NULL
order.rich <- as.data.frame(specnumber(order.rich.wide)) #species richness at walk level 

#trophic guild richness
trophic.rich <- site[,c(5, 14)] #pull walk, and trophic guild
trophic.rich.long <-  as.data.frame(table(trophic.rich)) #get freq of each species in long table with walks as rep
trophic.rich.long$walk <- as.numeric(trophic.rich.long$walk)
trophic.rich.wide <- trophic.rich.long %>% spread(trophic.guild, Freq) #get into wide format
trophic.rich.wide$walk <- NULL
trophic.rich <- as.data.frame(specnumber(trophic.rich.wide)) #species richness at walk level 

#bind together (position is correct) and rename columns
e <- bind_cols(species.rich, family.rich) %>% bind_cols(order.rich, trophic.rich)
colnames(e) <- c("species", "family", "order", "trophic guild") 




#simplifed dataframe with species as explanatory variable, 
ssp.3 <- site[,c(2, 4, 5, 12, 16, 19)]
#long abundance data
ssp.3.long.frame <- site[,c(4, 5, 12)]
ssp.3.long <-  as.data.frame(table(ssp.3.long.frame))
#wide format for ordinations
ssp.3.wide <- spread(ssp.3.long, species, Freq)



```


## Aggregations

### Difference in community between seasons

```{r, community season, warning=FALSE, echo=FALSE}
#walks and species
walks.ssp <- site[,c(4, 5, 12)] #pull season, walk, and species
walks.ssp.long <-  as.data.frame(table(walks.ssp)) #get freq of each species in long table with walks as rep
walks.ssp.wide <- walks.ssp.long %>% spread(species, Freq) #get species into wide format
walks.ssp.wide$walk <- as.numeric(walks.ssp.wide$walk) #make walks numeric
walks.ssp.wide <- filter(walks.ssp.wide, (season == "flower" & walk < 27) | (season == "fruit" & walk > 26)) #filter so only 1-26 of flowering season and 27-47 for fruiting season are present
walks.ssp.wide$season <- NULL #remove season
walks.ssp.wide$walk <- NULL #remove walks 
#must remove factors so that we can calculate diversity metrics later


#season walks and species
community.season <- site[,c(4, 5, 12)] #columns of interest
community.season.long <- as.data.frame(table(community.season)) #long with frequencies
community.season.long$walk <- as.numeric(community.season.long$walk)
community.season.wide <- community.season.long %>% spread(season, Freq) #incorrect



```

### Multiple metrics of community structure

I'd like to see the different metrics for community structure that ecologists use, so I need to create a dataset of all of these values, with "walk" as the replication level
```{r, community metrics, warning=FALSE, include=FALSE}
#covariates environmental data
cov <-  as.data.frame(table(ssp.3$walk, ssp.3$season)) #environmental data of all covariates in long format, for all community metrics to be added to
colnames(cov) <- c("walk","season", "abundance") #rename columns
cov$walk <- as.numeric(cov$walk) #make walk numeric
cov <- filter(cov, (season == "flower" & walk < 27) | (season == "fruit" & walk > 26))


#Diversity metrics
#richness
S <- as.data.frame(specnumber(walks.ssp.wide)) #species richness at walk level 

#shannons diversity
H <- as.data.frame(diversity(walks.ssp.wide))

#simpsons diversity
simp <- as.data.frame(diversity(walks.ssp.wide, "simpson"))

#evenness
J <- as.data.frame(H/log(S)) #NaN are walks with a species richness of 1, but go ahead and ignore (find out threshold 2-5%) and leave in unless there's too many

#turnover
#calculates total turnover, appearances, and disappearences
turnover <- turnover(df = community.season.long, 
                    time.var = "walk", 
                    species.var = "species", 
                    abundance.var = "Freq", 
                    replicate.var = "season")
turnover$season <- NULL

#Give each metric a "walk" column so it can be joined together in cov dataset
S$walk <- rownames(S) %>% as.numeric(S$walk)
H$walk <- rownames(H) %>% as.numeric(H$walk)
simp$walk <-rownames(simp) %>% as.numeric(simp$walk)
J$walk <- rownames(J) %>% as.numeric(J$walk)


#joining to combine our new diversity stats
cov <- cov %>% left_join(H, by = "walk") %>% left_join(S, by = "walk") %>% left_join(simp, by = "walk") %>% left_join(J, by = "walk") %>% left_join(turnover, by = "walk") 

#rename cov columns
colnames(cov) <- c("walk","season", "abundance", "shannon", "richness", "simpson", "evenness", "turnover") 

```


### Euclidean distances
```{r, Distance Matrix, warning=FALSE, echo=FALSE}
#distance matrix
#needed for Distance based ordinations (NMDS, PCoA, and PO)
#distance_matrix(ssp.3.wide, indices=NULL)
```



# Viz

## Maps

```{r, map, warning=FALSE}
#map of all bird sitings
deep.sunset <- get_map(location = c(lon = -115.663, lat = 34.7805), zoom = 17, color="bw")

site.wide.map <- ggmap(deep.sunset)
site.wide.map <- site.wide.map +
  geom_point(data=site, aes(x=lon, y=lat, colour = order, group = order), alpha = 3/10, size =4) +
  labs(title = "Site Wide Species Observations", x = "longitude", y = "latitude", color = "Order")
site.wide.map
```


## Histograms

```{r, Histograms, warning=FALSE, echo=FALSE}
#behaviors
#behaviors
hist.behavior <- ggplot(site, aes(x=broad.behavior, fill = as.factor(season))) + 
  geom_histogram(stat="count") + 
  facet_grid(.~season) +
  scale_fill_manual(values = c("#FFF47F", "#7FB2FF")) +
  theme_classic() + 
  labs(x = "Behavior Type", y = "Frequency of Behavior") +
  theme(legend.title = element_blank()) +
  theme(axis.text.x = element_text(angle = 60, hjust =1, size=12)) +
  theme(strip.text.x = element_blank()) 
hist.behavior


#mesohabitats

#Five level mesohabitats
hist.mesofive <- ggplot(site, aes(x=five.mesohabitat, fill = as.factor(season))) + 
  geom_histogram(stat="count") + 
  facet_grid(.~season) + 
  scale_fill_manual(values = c("#FFF47F", "#7FB2FF")) +
  theme_classic() + 
  labs(x = "Mesohabitat Type", y = "Frequency of Mesohabitat") +
  theme(legend.title = element_blank()) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size=12)) +
  theme(strip.text.x = element_blank()) 


#Three level mesohabitats
hist.mesothree <- ggplot(site, aes(x=three.mesohabitat, fill=as.factor(season))) + 
  geom_histogram(stat="count") + 
  facet_grid(.~season) + 
  scale_fill_manual(values = c("#FFF47F", "#7FB2FF")) +
  theme_classic() + 
  labs(x = "Mesohabitat Type", y = "Frequency of Mesohabitat") +
  theme(legend.title = element_blank()) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size=12)) +
  theme(strip.text.x = element_blank()) 


#Two level mesohabitats
hist.mesotwo <- ggplot(site, aes(x=two.mesohabitat, fill = as.factor(season))) + 
  geom_histogram(stat="count") + 
  facet_grid(.~season) + 
  scale_fill_manual(values = c("#FFF47F", "#7FB2FF")) +
  theme_classic() + 
  labs(x = "Mesohabitat Type", y = "Frequency of Mesohabitat") +
  theme(legend.title = element_blank()) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size=12)) +
  theme(strip.text.x = element_blank()) 


#histogram mesohabitats 
hist.meso <- ggarrange(hist.mesofive, hist.mesothree, hist.mesotwo, ncol=2, nrow=2) 
hist.meso

#diversity histograms
#order
hist.order <- ggplot(site, aes(x=order, fill = as.factor(season))) + 
  geom_histogram(stat="count") +
  facet_grid(.~season) +
  scale_fill_manual(values = c("#FFF47F", "#7FB2FF")) +
  theme_classic() + 
  labs(x = "Order", y = "Frequency of Order") +
  theme(legend.title = element_blank()) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size=12)) +
  theme(strip.text.x = element_blank())

#trophic
hist.trophic <- ggplot(site, aes(x=trophic.guild, fill = as.factor(season))) + 
  geom_histogram(stat="count") +
  facet_grid(.~season) +
  scale_fill_manual(values = c("#FFF47F", "#7FB2FF")) +
  theme_classic() + 
  labs(x = "Trophic Guild", y = "Frequency of Trophic Guild") +
  theme(legend.title = element_blank()) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size=12)) +
  theme(strip.text.x = element_blank())

#migratory class
hist.mig <- ggplot(site, aes(x=migratory.class, fill = as.factor(season))) + 
  geom_histogram(stat="count") +
  facet_grid(.~season) +
  scale_fill_manual(values = c("#FFF47F", "#7FB2FF")) +
  theme_classic() + 
  labs(x = "Migratory Class", y = "Frequency of Migratory Class") +
  theme(legend.title = element_blank()) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size=12)) +
  theme(strip.text.x = element_blank())

#diversity histograms together
hist.div <- ggarrange(hist.trophic, hist.order, hist.mig, ncol=2, nrow=2)
hist.div

#histogram of bird distance from transect
hist.dist <- ggplot(site, aes(x=distance, fill = as.factor(season))) + 
  geom_histogram(stat="count") +
  facet_grid(.~season) +
  scale_fill_manual(values = c("#FFF47F", "#7FB2FF")) +
  theme_classic() + 
  labs(x = "Distance", y = "Frequency of Distances") +
  theme(legend.title = element_blank()) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size=12)) +
  theme(strip.text.x = element_blank())
hist.dist

```



## Community Structure Metrics

Here we will visualize some standard metrics of community structure. These metrics include Shannon Weaver Indices, Simpson's Diversity Indices, Abudances, Richness, Evenness, and Turnover.

### Distributions 

```{r, comm dist, warning=FALSE, echo=FALSE}
abun.dist <- ggplot(cov, aes(x=abundance)) +
  geom_density() +
  theme_classic() + 
  theme(axis.title.y = element_blank()) +
  labs(x = "Abundance")

shan.dist <- ggplot(cov, aes(x=shannon)) +
  geom_density() +
  theme_classic() + 
  theme(axis.title.y = element_blank()) +
  labs(x = "Shannon's Diversity")

rich.dist <- ggplot(cov, aes(x=richness)) +
  geom_density() +
  theme_classic() + 
  theme(axis.title.y = element_blank()) +
  labs(x = "Richness")

simp.dist <- ggplot(cov, aes(x=simpson)) +
  geom_density() +
  theme_classic() + 
  theme(axis.title.y = element_blank()) +
  labs(x = "Simpson's Diversity")

even.dist <- ggplot(cov, aes(x=evenness)) +
  geom_density() +
  theme_classic() + 
  theme(axis.title.y = element_blank()) +
  labs(x = "Evenness")

turn.dist <- ggplot(cov, aes(x=turnover)) +
  geom_density() +
  theme_classic() + 
  theme(axis.title.y = element_blank()) +
  labs(x = "Turnover")

comm.dist <- ggarrange(abun.dist, shan.dist, rich.dist, simp.dist, even.dist, turn.dist, ncol=2, nrow=3)
comm.dist
```


### Boxplots of Community Structure Metrics between Seasons

```{r, boxplots, echo=FALSE, warning=FALSE}
shan.box <- ggplot(cov, aes(x=season, y=shannon, fill = season)) +
  geom_boxplot() +
  theme_classic() +
  theme(axis.text.x = element_text(size=12)) +
  scale_fill_manual(values=c("#FFB64C", "#B1E7C7")) +
  theme(legend.position="none") +
  theme(axis.title.x=element_blank()) +
  labs(y = "Shannon's Diversity")

abun.box <- ggplot(cov, aes(x=season, y=abundance, fill = season)) +
  geom_boxplot() +
  theme_classic() +
  theme(axis.text.x = element_text(size=12)) +
  scale_fill_manual(values=c("#FFB64C", "#B1E7C7")) +
  theme(legend.position="none") +
  theme(axis.title.x=element_blank()) +
  labs(y = "Abundance")

rich.box <- ggplot(cov, aes(x=season, y=richness, fill = season)) +
  geom_boxplot() +
  theme_classic() +
  theme(axis.text.x = element_text(size=12)) +
  scale_fill_manual(values=c("#FFB64C", "#B1E7C7")) +
  theme(legend.position="none") +
  theme(axis.title.x=element_blank()) +
  labs(y = "Richness")

simp.box <- ggplot(cov, aes(x=season, y=simpson, fill = season)) +
  geom_boxplot() +
  theme_classic() +
  theme(axis.text.x = element_text(size=12)) +
  scale_fill_manual(values=c("#FFB64C", "#B1E7C7")) +
  theme(legend.position="none") +
  theme(axis.title.x=element_blank()) +
  labs(y = "Simpson's Diversity")

even.box <- ggplot(cov, aes(x=season, y=evenness, fill = season)) +
  geom_boxplot() +
  theme_classic() +
  theme(axis.text.x = element_text(size=12)) +
  scale_fill_manual(values=c("#FFB64C", "#B1E7C7")) +
  theme(legend.position="none") +
  theme(axis.title.x=element_blank()) +
  labs(y = "Evenness")

turn.box <- ggplot(cov, aes(x=season, y=turnover, fill = season)) +
  geom_boxplot() +
  theme_classic() +
  theme(axis.text.x = element_text(size=12)) +
  scale_fill_manual(values=c("#FFB64C", "#B1E7C7")) +
  theme(legend.position="none") +
  theme(axis.title.x=element_blank()) +
  labs(y = "Turnover")

comm.box <- ggarrange(shan.box, simp.box, abun.box, rich.box, even.box, turn.box, nrow=3, ncol=2)
comm.box

```


# Models

Is there a difference in community structure between migration (spring) and breeding (summer) seasons?

## Community Metrics 

```{r, comm metrics models, warning=FALSE}
#GLMs require 0 and 1's for binary data
#Change "flower" and "fruit" to 0 and 1
#cov$season <- revalue(cov$season, c("flower"="0"))
#cov$season <- revalue(cov$season, c("fruit"="1"))


#GLMs checking for differences between different community structure metrics
#even.m <- glm(evenness~season, data=cov, family="binomial") ##glm for season's impact on abundance

#summary(abun.m)

```



Let's see how season (migration and breeding) impacted actual and functional diversity metrics. 

## Checking Factors and Models

### Correlation, colinearity, and multicolinearity

```{r, correlation, echo=FALSE, warning=FALSE}
#correlation matric
e.cor <- cor(e)
#correlation plot
corrplot(e.cor) #ignore walk and season.rep
#all strongly correlated, meaning multicolinearity is a problem among our explanatory variables, so we can't include them in a model together

```



## Diversity

### Species and three mesohabitat levels

```{r}
#pca1 <- rda(ssp.3.wide)

#step1 <- step(lm(mpg~wt+drat+disp+qsec,data=mtcars),direction="both")

```




### Chi-squared Tests 

We've agreed these are wrong. But for now, let's keep them accessible.
```{r, taxanomic abundance tests, warning=FALSE}
ssp.abundance <- data.frame(table(site$season, site$species))
species.wide <- spread(ssp.abundance, Var2, Freq)
rownames(species.wide) <- species.wide$Var1  
species.wide$Var1 <- NULL
chisq.test(species.wide)

fam.abundance<-data.frame(table(site$season, site$family))
fam.wide <- spread(fam.abundance, Var2, Freq)
rownames(fam.wide) <- fam.wide$Var1
fam.wide$Var1 <- NULL
chisq.test(fam.wide)

order.abundance <- data.frame(table(site$season, site$order))
order.wide <- spread(order.abundance, Var2, Freq)
rownames(order.wide) <- order.wide$Var1
order.wide$Var1 <- NULL
chisq.test(order.wide)
```
The test is significant for all taxanomic levels of actual abundance, but may not be the correct statistical test? All it tells us is there is a difference between migration and breeding seasons in regards to abundance (we know migration has higher abundance, but how so?). This is not super helpful. I wanted to do a redunancy analysis, but considering the independant factor isn't numeric, I'm not sure how to go about further. Perhaps, we should do just a t-test of Shannon-Weaver Indices? This way, we are also involving diversity, not just abundance.

Additionally, I am concerned because this chi-squared test doesn't incorporate the different levels of replication.

